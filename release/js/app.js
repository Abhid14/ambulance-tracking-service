var $$=Dom7;app=new Framework7({id:"ambulancetracker",root:"#app",theme:"md",routes}),window.matchMedia("(display-mode: standalone)").addEventListener("change",()=>{location.reload()});var firebaseConfig={apiKey:"AIzaSyD8dDiGzBMWw2JRAqdfLnHILQA0XHBFBFU",authDomain:"ambulancetrackerweb.firebaseapp.com",databaseURL:"https://ambulancetrackerweb-default-rtdb.firebaseio.com",projectId:"ambulancetrackerweb",storageBucket:"ambulancetrackerweb.appspot.com",messagingSenderId:"35818978401",appId:"1:35818978401:web:882a658ddba4816ec6fe20",measurementId:"G-C3M80W1F3Y"};firebase.initializeApp(firebaseConfig);const db=firebase.firestore();firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL),firebase.analytics(),firebase.auth().onAuthStateChanged(function(a){if(!a)window.matchMedia("(display-mode: standalone)").matches?document.getElementById("log").click():document.getElementById("pwainstall").click();else if(document.getElementById("resetloginform")&&(document.getElementById("resetloginform").click(),app.dialog.close()),window.matchMedia("(display-mode: standalone)").matches)switch(document.getElementById(localStorage.getItem("loggedDept")).click(),localStorage.getItem("loggedDept")){case"amb":getAmbData(a);break;case"pol":getPolData(a);}else document.getElementById("pwainstall").click()});function signUsrOut(){localStorage.clear(),firebase.auth().signOut().catch(function(a){if("auth/network-request-failed"==a.code)var b="Network error! Please check your connection.";else var b="Error signing out! Please try again";app.toast.create({text:b,closeTimeout:3e3}).open()})}function getPolData(a){$$(document).on("page:afterin",".page[data-name=\"police\"]",function(){if(localStorage.getItem("userUID")!=a.uid){app.dialog.preloader("Fetching Profile Data...");const b=db.collection("users").doc("police").collection("accounts").doc(a.uid);b.get().then(b=>{b.exists?(policeData=b.data(),localStorage.setItem("userUID",a.uid),localStorage.setItem("userNameP",policeData.userName),localStorage.setItem("userBranchP",policeData.userBranch),location.reload()):(app.dialog.close(),app.dialog.alert("User data doesn't exists / missing from the server please contact your administrator!","Error",signUsrOut))}).catch(a=>{console.log("Error getting document:",a.code)})}else document.getElementById("userNameP").innerText=localStorage.getItem("userNameP"),document.getElementById("userBranchP").innerText=localStorage.getItem("userBranchP"),document.getElementById("userEmailP").innerText=a.email,getPolMap()})}function getAmbData(a){$$(document).on("page:afterin",".page[data-name=\"ambulance\"]",function(){if(localStorage.getItem("userUID")!=a.uid){app.dialog.preloader("Fetching Profile Data...");const b=db.collection("users").doc("ambulance").collection("accounts").doc(a.uid);b.get().then(b=>{b.exists?(ambulanceData=b.data(),localStorage.setItem("userUID",a.uid),localStorage.setItem("userNameA",ambulanceData.userName),localStorage.setItem("userBranchA",ambulanceData.userBranch),localStorage.setItem("vehicleNumber",ambulanceData.vehicleNumber),localStorage.setItem("phoneNumber",ambulanceData.phoneNumber),location.reload()):(app.dialog.close(),app.dialog.alert("User data doesn't exists / missing from the server please contact your administrator!","Error",signUsrOut))}).catch(a=>{console.log("Error getting document:",a.code)})}else document.getElementById("userNameA").innerText=localStorage.getItem("userNameA"),document.getElementById("userBranchA").innerText=localStorage.getItem("userBranchA"),document.getElementById("vehicleNumber").innerText=localStorage.getItem("vehicleNumber"),document.getElementById("userEmailA").innerText=a.email,getAmbMap()})}function getNext(){globalThis.swiper=document.querySelector(".swiper-container").swiper,swiper.allowTouchMove=!1,swiper.slideNext()}function setDept(a){globalThis.userDept=a;"amb"===a?document.getElementById("deptImage").innerHTML="<img class='appstatusf' style='height: 150px; width: 150px; border-radius: 50%' src = '../static/icons/logo-256.png' />":"pol"===a?document.getElementById("deptImage").innerHTML="<img class='appstatusf' style='height: 150px; width: 150px; border-radius: 50%' src = '../static/icons/police.jpg' />":void 0;swiper.slideNext()}function signIn(){if(app.input.validateInputs(document.getElementById("login-form"))){app.dialog.preloader("Signing In...");var a=app.form.convertToData("#login-form");firebase.auth().signInWithEmailAndPassword(a.email,a.password).then(()=>{localStorage.setItem("loggedDept",userDept)}).catch(function(a){if(app.dialog.close(),"auth/network-request-failed"==a.code)var b="Network error! Please check your connection.";else var b="Invalid Email/Password! Try again.";app.toast.create({text:b,closeTimeout:3e3}).open()})}else app.toast.create({text:"Fill the required fields with valid details!",closeTimeout:2e3}).open()}function stopDataAmb(){runningops=!1,db.collection("runningops").doc(userUID).delete(),document.getElementById("startTripN").classList.add("hideMapEl"),document.getElementById("startTripB").onclick="startDataAmb()",document.getElementById("startTripB").classList.add("sheet-open"),document.getElementById("startTripT").innerText="START"}function sendDataAmb(){if(globalThis.userUID=localStorage.getItem("userUID"),globalThis.runningops=!0,app.input.validateInputs(document.getElementById("start-trip-form"))){var a=app.form.convertToData("#start-trip-form");navigator.geolocation.getCurrentPosition(b=>{var c=b.coords.latitude,d=b.coords.longitude;db.collection("runningops").doc(userUID).delete(),db.collection("runningops").doc(userUID).set({userName:localStorage.getItem("userNameA"),vehicleNumber:localStorage.getItem("vehicleNumber"),destination:a.destination,priority:+a.priority,userLocation:new firebase.firestore.GeoPoint(c,d),phoneNumber:localStorage.getItem("phoneNumber")}).then(()=>{console.log("Document successfully written to uid!");var a,b;b={enableHighAccuracy:!0,maximumAge:0},a=navigator.geolocation.watchPosition(function(a){if(!0==runningops){var b=a.coords;setTimeout(function(){db.collection("runningops").doc(userUID).update({userLocation:new firebase.firestore.GeoPoint(b.latitude,b.longitude)})},2500)}},function(){console.log("Error logging data to server! please check internet connection/ contact admin.")},b)}).catch(()=>{})}),document.getElementById("startTripB").classList.remove("sheet-open"),document.getElementById("startTripT").innerText="STOP",document.getElementById("startTripB").setAttribute("onclick","stopDataAmb()"),document.getElementById("resetstartform").click(),app.sheet.close(".amb-sheet"),document.getElementById("startTripN").classList.remove("hideMapEl")}else app.toast.create({text:"Fill the required fields with valid details!",closeTimeout:2e3}).open()}function getAmbMap(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(){mapboxgl.accessToken="pk.eyJ1IjoiYWJoaXJhbmdlcm1hcGJveCIsImEiOiJja25sNjJ4d3QwMjRzMnFsaTF2eno2Y2N0In0.R2nh61HBc6YfuLxTHO6SPw",globalThis.map=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:[78.31332119498711,21.80992239473943],zoom:3}),map.addControl(new mapboxgl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0})),map.once("load",function(){document.getElementsByClassName("mapboxgl-ctrl-geolocate")[0].click(),document.getElementById("startTripB").classList.remove("hideMapEl")})},function(a){a.code==a.PERMISSION_DENIED&&app.dialog.alert("Your Broswer / permission settings doesn't support Geolocation please troubleshoot and try again!","Error")}):app.dialog.alert("Your Broswer / permission settings doesn't support Geolocation please troubleshoot and try again!","Error")}function checkUID(a){return!(a[0]!=this)}function deg2rad(a){return a*(Math.PI/180)}function sortDistance(b,d,e,f){var g=deg2rad(e-b),h=deg2rad(f-d),i=Math.sin(g/2)*Math.sin(g/2)+Math.cos(deg2rad(b))*Math.cos(deg2rad(e))*Math.sin(h/2)*Math.sin(h/2),a=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return!!(4>6371*a)}function getPolMap(){mapboxgl.accessToken="pk.eyJ1IjoiYWJoaXJhbmdlcm1hcGJveCIsImEiOiJja25sNjJ4d3QwMjRzMnFsaTF2eno2Y2N0In0.R2nh61HBc6YfuLxTHO6SPw",globalThis.map=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:[78.31332119498711,21.80992239473943],zoom:3}),map.addControl(new mapboxgl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0})),map.once("load",function(){document.getElementsByClassName("mapboxgl-ctrl-geolocate")[0].click(),document.getElementById("nearPolL").classList.remove("hideMapEl"),document.getElementById("nearPolB").classList.remove("hideMapEl"),globalThis.nearPolL=document.getElementById("nearPolL"),globalThis.nearPolT=document.getElementById("nearPolT"),recieveOPSData()})}function folUsr(a){var b=ambList.findIndex(checkUID,a);app.sheet.close(".pol-sheet"),map.flyTo({center:[ambList[b][6],ambList[b][5]],essential:!0})}function addDetUI(usrDet){nearPolT.innerText=`${ambList.length} Running OPS`;var runLi=document.createElement("li");switch(usrDet[4]){case 1:var pty="color-yellow",pColor="#ffff00";break;case 2:var pty="color-orange",pColor="#ffa500";break;case 3:var pty="color-red",pColor="#ff0000";break;case 4:var pty="color-green",pColor="#33cc33";}runLi.innerHTML=`<a id="${usrDet[0]}"class="runOPSItem item-link item-content"><div class="item-inner"><div class="item-title-row"><div class="item-title">${usrDet[1]}</div><div class="item-after"><span class="badge ${pty}">${usrDet[4]}</span></div></div><div class="item-subtitle">${usrDet[2]}</div><div class="item-subtitle">${usrDet[3]}</div><div class="item-subtitle">${usrDet[7]}</div></div></a>`,$$(".runOPSCont").append(runLi),$$(".runOPSItem").on("click",function(){folUsr(this.id)}),eval(usrDet[0]+"= new mapboxgl.Marker({color: '"+pColor+"',}).setLngLat(["+usrDet[6]+", "+usrDet[5]+"]).addTo(map);"),"color-green"==pty&&app.dialog.alert("A Green corridor vehicle has been detected in your 4 km range!","Important Alert!")}function updateMarker(ix){switch(ambList[ix][4]){case 1:var pColor="#ffff00";break;case 2:var pColor="#ffa500";break;case 3:var pColor="#ff0000";break;case 4:var pColor="#33cc33";}var exC1=(ambList[ix][0]+".remove();").toString(),exC2=(ambList[ix][0]+"= new mapboxgl.Marker({color: '"+pColor+"',}).setLngLat(["+ambList[ix][6]+", "+ambList[ix][5]+"]).addTo(map);").toString();eval(exC1),eval(exC2)}function removeMarker(id){if(0<ambList.length)try{var changeIndex=ambList.findIndex(checkUID,id);if("number"==typeof changeIndex)if(ambList.splice(changeIndex,1),0==ambList.length){runOPSListStat=0,nearPolT.innerText="No Running OPS",nearPolL.classList.remove("sheet-open","color-orange"),nearPolL.classList.add("color-green");var exC1=(id+".remove();").toString();document.getElementById(id).remove(),eval(exC1)}else{nearPolT.innerText=`${ambList.length} Running OPS`;var exC1=(id+".remove();").toString();document.getElementById(id).remove(),eval(exC1)}}catch(a){console.log(a)}}function addAmbList(a,b){navigator.geolocation.getCurrentPosition(c=>{if(!0===sortDistance(c.coords.latitude,c.coords.longitude,a.userLocation.latitude,a.userLocation.longitude)){var d=[b,a.userName,a.vehicleNumber,a.destination,a.priority,a.userLocation.latitude,a.userLocation.longitude,a.phoneNumber];ambList.push(d),addDetUI(d),0==runOPSListStat&&(runOPSListStat=1,nearPolL.classList.add("sheet-open","color-orange"))}})}function recieveOPSData(){globalThis.firstSyncSuccess=!1,globalThis.ambList=[],globalThis.runOPSListStat=0,db.collection("runningops").onSnapshot(a=>{a.docChanges().forEach(a=>{if("added"===a.type&&addAmbList(a.doc.data(),a.doc.id),"modified"===a.type&&!0==firstSyncSuccess)if(0<ambList.length)try{var b=ambList.findIndex(checkUID,a.doc.id);0<=b?(ambList[b][5]=a.doc.data().userLocation.latitude,ambList[b][6]=a.doc.data().userLocation.longitude,updateMarker(b)):addAmbList(a.doc.data(),a.doc.id)}catch(a){console.log(a)}else{var c=ambList.findIndex(checkUID,a.doc.id);-1!=c&&addAmbList(a.doc.data(),a.doc.id)}"removed"===a.type&&removeMarker(a.doc.id)})})}